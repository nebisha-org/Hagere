name: Distribute iOS to Firebase

on:
  push:
    branches: [ main ]   # change if your default branch is different

jobs:
  ios-firebase-distribute:
    runs-on: macos-latest

    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
      IOS_CERTIFICATE_P12_BASE64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
      IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Decode iOS certificate and provisioning profile
        run: |
          echo "$IOS_CERTIFICATE_P12_BASE64" | base64 --decode > ios_dist.p12
          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > ios_dist.mobileprovision

      - name: Create keychain and import certificate
        run: |
          security create-keychain -p "" build.keychain
          security import ios_dist.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          UUID=$(grep -a -o "<key>UUID</key><string>[-A-F0-9]\{36\}</string>" ios_dist.mobileprovision | \
                 sed -E 's/.*<string>(.*)<\/string>.*/\1/')
          cp ios_dist.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
      - name: Ensure CocoaPods is set up
        run: |
          pod --version
          pod setup

      - name: Pre-install iOS pods
        run: |
          # Reset CocoaPods specs repo and add trunk explicitly
          rm -rf ~/.cocoapods/repos
          pod repo add trunk https://cdn.cocoapods.org/

          cd ios
          pod install
          cd ..
          
      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS IPA
        run: flutter build ipa --release

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Upload to Firebase App Distribution
        run: |
          firebase appdistribution:distribute build/ios/ipa/Runner.ipa \
            --app "$FIREBASE_IOS_APP_ID" \
            --groups "internal-testers" \
            --token "$FIREBASE_TOKEN"


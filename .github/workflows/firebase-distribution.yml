name: Mobile CI/CD (Push -> Test Distribution -> Manual Production)

on:
  workflow_dispatch:
  push:
    branches:
      - v2
      - main

permissions:
  contents: read

concurrency:
  group: mobile-cicd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare Canonical Build Metadata
    runs-on: ubuntu-latest
    outputs:
      ci_build_number: ${{ steps.meta.outputs.ci_build_number }}
      app_version: ${{ steps.meta.outputs.app_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute build metadata
        id: meta
        run: |
          VERSION_LINE="$(awk '/^version:/ {print $2; exit}' pubspec.yaml)"
          APP_VERSION="${VERSION_LINE%%+*}"
          CI_BUILD_NUMBER="$(date +%s)"
          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"
          echo "ci_build_number=$CI_BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          mkdir -p ci_meta
          cat > ci_meta/build_manifest.json <<EOF
          {
            "ci_build_number": "$CI_BUILD_NUMBER",
            "app_version": "$APP_VERSION",
            "commit_sha": "${GITHUB_SHA}",
            "git_ref": "${GITHUB_REF}",
            "run_id": "${GITHUB_RUN_ID}",
            "run_attempt": "${GITHUB_RUN_ATTEMPT}"
          }
          EOF

      - name: Upload canonical manifest
        uses: actions/upload-artifact@v4
        with:
          name: canonical-build-manifest
          path: ci_meta/build_manifest.json
          retention-days: 14

  android_build_distribute:
    name: Android Build + Firebase Distribution
    needs: prepare
    runs-on: ubuntu-latest
    outputs:
      android_version_code: ${{ steps.android_meta.outputs.android_version_code }}
    env:
      BUILD_NUMBER: ${{ needs.prepare.outputs.ci_build_number }}
      FIREBASE_PROJECT_ID: ${{ vars.FIREBASE_PROJECT_ID || 'hagere-663c4' }}
      FIREBASE_TESTER_GROUPS: ${{ vars.FIREBASE_TESTER_GROUPS || 'testers' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.2"
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Validate Android release secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          missing=0
          for name in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_PASSWORD KEY_ALIAS FIREBASE_ANDROID_APP_ID FIREBASE_TOKEN; do
            if [[ -z "${!name}" ]]; then
              echo "Missing required secret: $name"
              missing=1
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/my-release-key.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=my-release-key.jks
          EOF

      - name: Build Android AAB + APK
        run: |
          flutter build appbundle --release --build-number "$BUILD_NUMBER"
          flutter build apk --release --build-number "$BUILD_NUMBER"

      - name: Capture Android build metadata
        id: android_meta
        run: |
          ANDROID_VERSION_CODE="$(jq -r '.elements[0].versionCode' build/app/outputs/flutter-apk/output-metadata.json)"
          echo "android_version_code=$ANDROID_VERSION_CODE" >> "$GITHUB_OUTPUT"
          mkdir -p ci_meta
          cat > ci_meta/android_manifest.json <<EOF
          {
            "ci_build_number": "$BUILD_NUMBER",
            "android_version_code": "$ANDROID_VERSION_CODE",
            "app_version": "${{ needs.prepare.outputs.app_version }}",
            "commit_sha": "${GITHUB_SHA}",
            "run_id": "${GITHUB_RUN_ID}"
          }
          EOF

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Distribute to Firebase testers + automated device tests
        run: |
          firebase --project "$FIREBASE_PROJECT_ID" appdistribution:distribute build/app/outputs/flutter-apk/app-release.apk \
            --app "${{ secrets.FIREBASE_ANDROID_APP_ID }}" \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --groups "$FIREBASE_TESTER_GROUPS" \
            --test-devices-file scripts/firebase_test_devices_android.txt

      - name: Upload Android build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-artifacts
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/flutter-apk/output-metadata.json
            ci_meta/android_manifest.json
          retention-days: 14

  ios_build_distribute:
    name: iOS Build + TestFlight Distribution
    needs: prepare
    runs-on: macos-latest
    env:
      CI_BUILD_NUMBER: ${{ needs.prepare.outputs.ci_build_number }}
      TESTFLIGHT_GROUPS: ${{ vars.TESTFLIGHT_GROUPS || '' }}
      TESTFLIGHT_NOTIFY_EXTERNAL: ${{ vars.TESTFLIGHT_NOTIFY_EXTERNAL || '0' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.2"
          channel: stable
          cache: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: ios

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Validate iOS release secrets
        env:
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_KEY_CONTENT_BASE64: ${{ secrets.ASC_KEY_CONTENT_BASE64 }}
          IOS_CERTIFICATE_P12_BASE64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          missing=0
          for name in ASC_ISSUER_ID ASC_KEY_ID ASC_KEY_CONTENT_BASE64 IOS_CERTIFICATE_P12_BASE64 IOS_CERTIFICATE_PASSWORD IOS_PROVISIONING_PROFILE_BASE64; do
            if [[ -z "${!name}" ]]; then
              echo "Missing required secret: $name"
              missing=1
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi

      - name: Configure iOS signing keychain and profile
        env:
          IOS_CERTIFICATE_P12_BASE64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="${IOS_KEYCHAIN_PASSWORD:-ci-temporary-keychain-password}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "$IOS_CERTIFICATE_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/dist.p12"
          security import "$RUNNER_TEMP/dist.p12" -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/ci.mobileprovision"

      - name: Install CocoaPods
        run: |
          cd ios
          bundle install
          bundle exec pod install

      - name: Upload canonical iOS build to TestFlight
        env:
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_KEY_CONTENT_BASE64: ${{ secrets.ASC_KEY_CONTENT_BASE64 }}
          CI_WAIT_FOR_TESTFLIGHT_PROCESSING: "1"
        run: |
          cd ios
          bundle exec fastlane ios beta

      - name: Capture iOS build metadata
        run: |
          mkdir -p ci_meta
          cat > ci_meta/ios_manifest.json <<EOF
          {
            "ci_build_number": "${CI_BUILD_NUMBER}",
            "app_version": "${{ needs.prepare.outputs.app_version }}",
            "bundle_id": "com.digitalnebi.allhabesha",
            "commit_sha": "${GITHUB_SHA}",
            "run_id": "${GITHUB_RUN_ID}"
          }
          EOF

      - name: Upload iOS metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-manifest
          path: ci_meta/ios_manifest.json
          retention-days: 14

  promote_production:
    name: Manual Approval -> Promote Exact CI Build
    needs:
      - prepare
      - android_build_distribute
      - ios_build_distribute
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download canonical manifest
        uses: actions/download-artifact@v4
        with:
          name: canonical-build-manifest
          path: dist/meta

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release-artifacts
          path: dist/android

      - name: Download iOS manifest
        uses: actions/download-artifact@v4
        with:
          name: ios-release-manifest
          path: dist/ios

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: ios

      - name: Validate production promotion secrets
        env:
          PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_KEY_CONTENT_BASE64: ${{ secrets.ASC_KEY_CONTENT_BASE64 }}
        run: |
          missing=0
          for name in PLAY_SERVICE_ACCOUNT_JSON_BASE64 ASC_ISSUER_ID ASC_KEY_ID ASC_KEY_CONTENT_BASE64; do
            if [[ -z "${!name}" ]]; then
              echo "Missing required secret: $name"
              missing=1
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi

      - name: Decode Play service account key
        env:
          PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
        run: |
          echo "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" | base64 --decode > "$RUNNER_TEMP/play-service-account.json"

      - name: Promote same Android AAB to production
        run: |
          cd ios
          bundle exec fastlane run upload_to_play_store \
            package_name:"com.digitalnebi.allhabesha" \
            json_key:"$RUNNER_TEMP/play-service-account.json" \
            aab:"$GITHUB_WORKSPACE/dist/android/build/app/outputs/bundle/release/app-release.aab" \
            track:"production" \
            release_status:"completed" \
            skip_upload_metadata:true \
            skip_upload_images:true \
            skip_upload_screenshots:true \
            skip_upload_changelogs:true \
            timeout:600

      - name: Submit same iOS build for App Review
        env:
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_KEY_CONTENT_BASE64: ${{ secrets.ASC_KEY_CONTENT_BASE64 }}
          ASC_APP_VERSION: ${{ needs.prepare.outputs.app_version }}
          ASC_BUILD_NUMBER: ${{ needs.prepare.outputs.ci_build_number }}
        run: |
          cd ios
          bundle exec fastlane ios submit_ci_build_for_review

      - name: Summarize canonical promotion
        run: |
          {
            echo "### Canonical Promotion Completed"
            echo "- Commit: \`${GITHUB_SHA}\`"
            echo "- CI build number: \`${{ needs.prepare.outputs.ci_build_number }}\`"
            echo "- Android versionCode: \`${{ needs.android_build_distribute.outputs.android_version_code }}\`"
            echo "- iOS build number: \`${{ needs.prepare.outputs.ci_build_number }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
